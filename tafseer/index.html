const urls = [
    { name: 'Tafsir Tahlili (Indonesian)', url: 'https://muslim1446.github.io/tafseer/tahlili_kemenag_id', description: 'Detailed, methodical, and suited for those seeking a deep and scholarly analysis of the Quran.' },
    { name: 'Tafsir Wajiz Kemenag (Indonesian)', url: 'https://muslim1446.github.io/tafseer/id_wajiz_kemenag', description: 'Concise, accessible, and designed for easy comprehension by a broader audience.' },
    { name: 'Tafsir ibn Kathir (English)', url: 'https://muslim1446.github.io/tafseer/en_ibn-kathir_Quran', description: 'One of the most famous Islamic books concerned with the science of interpretation of the Qur\'an.' }
];

let chapters = [];
const MAX_VERSE_NUMBER = 6236;

async function fetchAndDisplayData() {
    try {
        const response = await fetch('https://muslim1446.github.io/tafseer/per6326name.txt');
        const text = await response.text();

        const lines = text.trim().split('\n');
        let html = '';
        let currentChapter = '';
        chapters = [];

        lines.forEach(line => {
            const chapterMatch = line.match(/^Chapter (\d+) \((.+)\):$/);
            const verseMatch = line.match(/^  Verse (\d+): (\d+)$/);

            if (chapterMatch) {
                if (currentChapter) {
                    html += '</tbody></table>';
                }
                currentChapter = chapterMatch[2];
                chapters.push({
                    number: chapterMatch[1],
                    name: currentChapter,
                    id: `chapter-${chapterMatch[1]}`
                });

                html += `<h2 id="chapter-${chapterMatch[1]}"><a href="/tafseer/sura#${chapterMatch[1]}" class="chapter-link">Surah ${chapterMatch[1]} (${currentChapter})</a></h2>`;
                html += `<table><thead><tr><th>Ayahs</th><th>Tafseer Number (from ${MAX_VERSE_NUMBER} ayahs in Qur'an)</th></tr></thead><tbody>`;
            } else if (verseMatch) {
                html += `<tr id="verse-${verseMatch[2]}"><td>Ayah ${verseMatch[1]}</td><td><a href="#" id="link-${verseMatch[2]}" data-verse="${verseMatch[2]}">${verseMatch[2]}</a></td></tr>`;
            }
        });

        if (currentChapter) {
            html += '</tbody></table>';
        }

        document.getElementById('content').innerHTML = html;

        const fuse = new Fuse(chapters, { keys: ['number', 'name'] });
        window.fuse = fuse;

        document.querySelectorAll('a[data-verse]').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                const verse = this.getAttribute('data-verse');
                const hash = `#${verse}`;
                showURLSelectionDialog(hash);
            });
        });

        // Handle URL parameters for chapter and verse
        const chapterParam = new URLSearchParams(window.location.search).get('sura');
        if (chapterParam) {
            const [chapNum, verseNum] = chapterParam.split('-');
            const chapterElement = document.getElementById(`chapter-${chapNum}`);
            if (chapterElement) {
                chapterElement.scrollIntoView({ behavior: 'smooth' });
                console.log(`Scrolled to chapter ${chapNum}`);
                // Delay for smooth scrolling to chapter
                setTimeout(() => {
                    if (verseNum) {
                        const verseElement = document.getElementById(`verse-${verseNum}`);
                        if (verseElement) {
                            verseElement.scrollIntoView({ behavior: 'smooth' });
                            console.log(`Scrolled to verse ${verseNum}`);
                        } else {
                            console.warn(`Verse ${verseNum} not found`);
                        }
                    }
                }, 1000); // Delay to ensure chapter scroll completes
            } else {
                console.warn(`Chapter ${chapNum} not found`);
            }
        }
    } catch (error) {
        console.error('Error fetching or processing the data:', error);
    }
}

function showURLSelectionDialog(hash) {
    const dialog = document.getElementById('urlDialog');
    const overlay = document.getElementById('overlay');
    
    dialog.innerHTML = '';

    urls.forEach(({ name, url, description }) => {
        const button = document.createElement('button');
        button.innerHTML = `<span class="btitle">${name}</span><br><span class="description">${description}</span>`;
        button.onclick = () => {
            window.location.href = `${url}${hash}`;
        };
        dialog.appendChild(button);
    });

    dialog.style.display = 'block';
    overlay.style.display = 'block';

    overlay.onclick = () => {
        dialog.style.display = 'none';
        overlay.style.display = 'none';
    };
}

function searchChapters() {
    const query = document.getElementById('searchInput').value;
    const results = window.fuse.search(query);
    const searchResults = document.getElementById('searchResults');
    
    searchResults.innerHTML = '';

    results.forEach(result => {
        const chapter = result.item;
        const listItem = document.createElement('li');
        listItem.textContent = `Surah ${chapter.number} (${chapter.name})`;
        listItem.style.cursor = 'pointer';
        listItem.onclick = () => {
            document.getElementById(chapter.id).scrollIntoView({ behavior: 'smooth' });
        };
        searchResults.appendChild(listItem);
    });
}

fetchAndDisplayData();
